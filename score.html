<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>TTFL Live Score</title>
  <style>
    :root{
      --pad-top: max(14px, env(safe-area-inset-top));
      --pad-bot: max(16px, env(safe-area-inset-bottom));
      --pad-x: 14px;

      --bg:#0b0d12;
      --panel: rgba(255,255,255,0.07);
      --panel2: rgba(255,255,255,0.09);
      --text:#f5f7ff;
      --muted: rgba(245,247,255,0.70);
      --muted2: rgba(245,247,255,0.55);

      --blue:#2f6dff;
      --orange:#ff9b2f;

      --btn: rgba(255,255,255,0.10);
      --btn2: rgba(255,255,255,0.14);

      --shadow: 0 14px 40px rgba(0,0,0,0.40);
      --r:18px;
      --r2:22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 800px at 50% -10%, rgba(47,109,255,0.32), transparent 55%),
        radial-gradient(900px 600px at 110% 10%, rgba(255,155,47,0.25), transparent 50%),
        var(--bg);
      color:var(--text);
      overflow:hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      padding: var(--pad-top) var(--pad-x) var(--pad-bot);
      gap: 12px;
      max-width: 520px;
      margin: 0 auto;
    }

    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: var(--shadow);
    }
    .title{
      font-weight: 950;
      letter-spacing: 0.2px;
      font-size: 14px;
      line-height: 1.15;
    }
    .sub{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      margin-top: 2px;
    }
    .status{
      display:flex; align-items:center; gap:8px;
      font-size:12px; color:var(--muted);
      white-space:nowrap;
    }
    .dot{width:9px;height:9px;border-radius:999px;background:#9ca3af}
    .dot.ok{background:#22c55e}
    .dot.bad{background:#ef4444}

    .pages{
      flex:1;
      border-radius: var(--r2);
      overflow:hidden;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: var(--shadow);
      position:relative;
    }
    .track{
      height:100%;
      display:flex;
      transform: translateX(0%);
      transition: transform 220ms ease;
    }
    .page{
      width:100%;
      flex: 0 0 100%;
      padding: 14px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap: 12px;
    }

    .card{
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      padding: 14px;
    }
    .label{font-size:12px;color:var(--muted);font-weight:900;margin-bottom:6px}
    input, select{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.22);
      color: var(--text);
      padding: 12px 12px;
      font-size: 15px;
      outline:none;
    }
    input::placeholder{color: rgba(245,247,255,0.45)}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hint{font-size:12px;color:var(--muted2);line-height:1.35}

    .btn{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.10);
      color: var(--text);
      font-weight: 950;
      padding: 14px 12px;
      font-size: 16px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .btn.primary{
      background: var(--blue);
      border-color: rgba(47,109,255,0.35);
      box-shadow: 0 10px 24px rgba(47,109,255,0.25);
    }
    .btn.orange{
      background: var(--orange);
      color:#111;
      border-color: rgba(255,155,47,0.35);
    }
    .btn.danger{
      background: rgba(239,68,68,0.18);
      border-color: rgba(239,68,68,0.25);
    }
    .btn:disabled{opacity:0.55;cursor:not-allowed}

    /* Live score tiles */
    .scoreGrid{display:grid;grid-template-columns:1fr 1fr;gap: 12px;}
    .tile{
      border-radius: 22px;
      padding: 14px 12px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      min-height: 210px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .tile.blue{
      background: radial-gradient(600px 300px at 30% 10%, rgba(255,255,255,0.20), transparent 55%), var(--blue);
    }
    .tile.orange{
      background: radial-gradient(600px 300px at 30% 10%, rgba(255,255,255,0.18), transparent 55%), var(--orange);
      color:#111;
    }
    .pname{
      font-weight: 950;
      font-size: 14px;
      letter-spacing:0.2px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      opacity:0.95;
    }
    .serveDot{
      width: 10px;height: 10px;border-radius: 999px;
      background: rgba(255,255,255,0.85);
      box-shadow: 0 0 0 5px rgba(255,255,255,0.20);
      opacity:0;
    }
    .serveDot.on{opacity:1}
    .pts{
      font-weight: 1000;
      font-size: 84px;
      line-height: 1;
      text-align:center;
      margin-top: 8px;
      letter-spacing: -1px;
    }

    /* Small stats */
    .stats{
      display:grid;
      grid-template-columns:1fr auto 1fr;
      align-items:center;
      gap: 10px;
      padding: 10px;
      border-radius: 18px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .divider{width:1px;height:32px;background: rgba(255,255,255,0.22);border-radius:9px}
    .stat{text-align:center;font-weight:950;letter-spacing:0.6px}
    .stat .t{font-size:12px;color:var(--muted)}
    .stat .v{font-size:20px;margin-top:4px;font-variant-numeric: tabular-nums}

    /* Set history always visible */
    .setsBox{
      margin-top: 10px;
      padding: 12px;
      border-radius: 18px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .setsHead{
      display:flex; align-items:center; justify-content:space-between;
      font-weight: 950;
      letter-spacing:0.6px;
      margin-bottom: 8px;
    }
    .setsList{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
    }
    .chip{
      border-radius: 999px;
      padding: 8px 10px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.12);
      font-weight: 950;
      font-size: 13px;
      font-variant-numeric: tabular-nums;
    }

    /* Controls */
    .controls{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .wide{grid-column: 1 / -1}
    .hidden{display:none !important;}
    .centerHint{display:grid;place-items:center;height:100%;text-align:center;color:var(--muted)}
    .bigWait{font-weight:1000;font-size:18px;color:var(--text);margin-bottom:6px}

    /* Bottom dots */
    .dots{display:flex;justify-content:center;gap:8px;padding:6px 0 2px;opacity:0.9}
    .dots span{width:8px;height:8px;border-radius:999px;background: rgba(255,255,255,0.25)}
    .dots span.on{background: rgba(255,255,255,0.85)}
  </style>
</head>

<body>
<div class="app">

  <div class="top">
    <div>
      <div class="title">Table Tennis For Life - Live Score Card</div>
      <div class="sub"><span id="roleTxt">watch</span> • Room: <span id="roomTxt">ttfl</span></div>
    </div>
    <div class="status">
      <span class="dot" id="dot"></span>
      <span id="net">Starting…</span>
    </div>
  </div>

  <div class="pages">
    <div class="track" id="track">

      <!-- PAGE 0: Home / Waiting -->
      <section class="page">
        <div class="card">
          <div class="label">Live status</div>
          <div class="hint" id="homeMsg">Waiting for a match to start…</div>
          <div style="height:10px"></div>
          <div class="hint">Watchers will automatically jump to live score when the scorer starts a match.</div>
        </div>

        <div class="controls" id="homeButtons">
          <button class="btn primary wide" id="btnGoLive">Go to Live Score</button>
          <button class="btn wide" id="btnSettings">Settings</button>
        </div>
      </section>

      <!-- PAGE 1: Settings -->
      <section class="page">
        <div class="card">
          <div class="label">First player</div>
          <input id="nameA" placeholder="Tanvi"/>

          <div style="height:10px"></div>

          <div class="label">Second player</div>
          <input id="nameB" placeholder="Opponent"/>

          <div style="height:10px"></div>

          <div class="label">Who starts?</div>
          <select id="starts">
            <option value="A">First player starts</option>
            <option value="B">Second player starts</option>
          </select>

          <div style="height:12px"></div>

          <div class="row2">
            <div>
              <div class="label">Best of</div>
              <select id="bestOf">
                <option value="3">3</option>
                <option value="5" selected>5</option>
                <option value="7">7</option>
              </select>
            </div>
            <div>
              <div class="label">Points</div>
              <select id="ptWin">
                <option value="11" selected>11</option>
                <option value="21">21</option>
              </select>
            </div>
          </div>

          <div style="height:12px"></div>
          <div class="hint">Scorer starts matches from Home. Watchers do not need to change anything.</div>
        </div>

        <div class="controls">
          <button class="btn" id="btnBackSettings">Back</button>
          <button class="btn primary" id="btnSaveSettings">Save</button>
        </div>
      </section>

      <!-- PAGE 2: Live score -->
      <section class="page" id="livePage">
        <div>
          <div class="scoreGrid">
            <div class="tile blue">
              <div class="pname"><span id="aLabel">Player A</span><span class="serveDot" id="aServe"></span></div>
              <div class="pts" id="aPts">0</div>
            </div>
            <div class="tile orange">
              <div class="pname"><span id="bLabel">Player B</span><span class="serveDot" id="bServe"></span></div>
              <div class="pts" id="bPts">0</div>
            </div>
          </div>

          <div class="stats" style="margin-top:10px;">
            <div class="stat"><div class="t">GAMES</div><div class="v" id="games">0:0</div></div>
            <div class="divider"></div>
            <div class="stat"><div class="t">MATCH</div><div class="v" id="matchScore">0:0</div></div>
          </div>

          <div class="setsBox">
            <div class="setsHead">
              <div>PREVIOUS GAMES</div>
              <div class="hint" id="matchIdTxt" style="margin:0;">—</div>
            </div>
            <div class="setsList" id="setsList"></div>
          </div>
        </div>

        <div class="controls hidden" id="scorerControls">
          <button class="btn primary" id="btnPlusA">+1 (A)</button>
          <button class="btn orange" id="btnPlusB">+1 (B)</button>
          <button class="btn" id="btnUndo">Undo</button>
          <button class="btn" id="btnSwap">Swap serve</button>
          <button class="btn danger wide" id="btnEnd">End Match</button>
        </div>

        <div class="centerHint hidden" id="watchHint">
          <div>
            <div class="bigWait">Watching live</div>
            <div class="hint">No refresh needed.</div>
          </div>
        </div>
      </section>

      <!-- PAGE 3: Result -->
      <section class="page">
        <div class="card" id="resultCard">
          <div class="label">Result</div>
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <div style="font-weight:1000;font-size:22px;" id="winnerTxt">—</div>
            <div class="hint" id="endedAtTxt" style="margin:0;">—</div>
          </div>
          <div style="height:10px"></div>
          <div style="display:flex;align-items:center;justify-content:center;gap:10px;font-weight:1000;font-size:42px;">
            <span style="padding:10px 16px;border-radius:16px;background:var(--blue);box-shadow:var(--shadow);" id="resA">0</span>
            <span style="opacity:.7">:</span>
            <span style="padding:10px 16px;border-radius:16px;background:var(--orange);color:#111;box-shadow:var(--shadow);" id="resB">0</span>
          </div>

          <div style="height:12px"></div>
          <div class="label">Games (sets)</div>
          <div class="setsList" id="setsListResult"></div>
        </div>

        <div class="controls" id="resultControls">
          <button class="btn wide" id="btnSaveImage">Save Result Image</button>
          <button class="btn primary wide hidden" id="btnNewMatch">Start New Match</button>
          <button class="btn wide" id="btnBackHome">Back</button>
        </div>
      </section>

    </div>
  </div>

  <div class="dots" id="dots">
    <span class="on"></span><span></span><span></span><span></span>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, onValue, get, set, update, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // =========================
  // PASTE YOUR firebaseConfig HERE
  // =========================
const firebaseConfig = {
  apiKey: "AIzaSyD221i61Z824UbXSLRT-UZs7w60KNzh5nY",
  authDomain: "ttfl-live-score.firebaseapp.com",
  databaseURL: "https://ttfl-live-score-default-rtdb.firebaseio.com",
  projectId: "ttfl-live-score",
  storageBucket: "ttfl-live-score.firebasestorage.app",
  messagingSenderId: "698939580201",
  appId: "1:698939580201:web:80540510de083f676ce138"
};

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  const $ = (id) => document.getElementById(id);

  const params = new URL(location.href).searchParams;
  const role = (params.get("role") || "watch").toLowerCase() === "scorer" ? "scorer" : "watch";
  const roomId = (params.get("room") || "ttfl").trim();

  $("roleTxt").textContent = role;
  $("roomTxt").textContent = roomId;

  // UI routing
  const track = $("track");
  const dots = [...$("dots").querySelectorAll("span")];
  let pageIndex = 0;
  function goto(i){
    pageIndex = Math.max(0, Math.min(3, i));
    track.style.transform = `translateX(${-100*pageIndex}%)`;
    dots.forEach((d,idx)=>d.classList.toggle("on", idx===pageIndex));
  }

  // Status dot
  function setNet(ok,msg){
    $("dot").className = "dot " + (ok ? "ok" : "bad");
    $("net").textContent = msg;
  }

  // Show/Hide by role
  $("scorerControls").classList.toggle("hidden", role !== "scorer");
  $("watchHint").classList.toggle("hidden", role !== "watch");
  $("btnNewMatch").classList.toggle("hidden", role !== "scorer");
  $("btnSettings").classList.toggle("hidden", role !== "scorer"); // watchers do not need settings
  $("btnSaveSettings").classList.toggle("hidden", role !== "scorer");

  // Firebase refs
  const roomRef = ref(db, `rooms/${roomId}`);
  const currentMatchRef = ref(db, `rooms/${roomId}/currentMatchId`);
  let matchUnsub = null;
  let currentMatchId = null;

  // Local state
  let uid = null;
  let matchData = null;

  function iso(){ return new Date().toISOString(); }
  function fmtTime(d){
    const dt = new Date(d);
    const hh = String(dt.getHours()%12 || 12);
    const mm = String(dt.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }

  function need(bestOf){ return Math.floor(bestOf/2)+1; }
  function gameWinner(a,b,ptWin){
    const max=Math.max(a,b), min=Math.min(a,b);
    if(max<ptWin) return null;
    if((max-min)<2) return null;
    return a>b ? "A" : "B";
  }
  function computeServer(m){
    const total = m.pointsA + m.pointsB;
    const deuce = (m.pointsA >= m.pointsToWin-1) && (m.pointsB >= m.pointsToWin-1);
    const period = deuce ? 1 : 2;
    const flips = Math.floor(total / period);
    const start = m.serverStart || "A";
    return (flips % 2 === 0) ? start : (start==="A" ? "B" : "A");
  }

  function renderSets(listEl, sets){
    listEl.innerHTML = "";
    if(!sets || sets.length === 0){
      const empty = document.createElement("div");
      empty.className = "hint";
      empty.textContent = "No games yet.";
      listEl.appendChild(empty);
      return;
    }
    sets.forEach((s, idx)=>{
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.textContent = `${idx+1}) ${s.a}-${s.b}`;
      listEl.appendChild(chip);
    });
  }

  function renderMatch(s){
    matchData = s;
    if(!s || !s.match){
      $("homeMsg").textContent = "Waiting for a match to start…";
      return;
    }

    const m = s.match;
    $("matchIdTxt").textContent = currentMatchId ? `#${currentMatchId}` : "—";

    $("aLabel").textContent = m.teamAName || "Player A";
    $("bLabel").textContent = m.teamBName || "Player B";
    $("aPts").textContent = m.pointsA ?? 0;
    $("bPts").textContent = m.pointsB ?? 0;
    $("games").textContent = `${m.gamesA ?? 0}:${m.gamesB ?? 0}`;
    $("matchScore").textContent = `${m.matchesA ?? 0}:${m.matchesB ?? 0}`;

    const srv = computeServer(m);
    $("aServe").classList.toggle("on", srv==="A");
    $("bServe").classList.toggle("on", srv==="B");

    renderSets($("setsList"), s.sets || []);
    renderSets($("setsListResult"), s.sets || []);

    // result
    $("resA").textContent = (m.matchesA ?? 0);
    $("resB").textContent = (m.matchesB ?? 0);
    $("winnerTxt").textContent = m.winner ? `Winner: ${m.winner}` : "Result";
    $("endedAtTxt").textContent = m.endedAt ? `Ended ${fmtTime(m.endedAt)}` : "";

    // Home message
    if(m.matchOver){
      $("homeMsg").textContent = "Match ended. Waiting for next match…";
    } else {
      $("homeMsg").textContent = "Match is live now.";
    }

    // AUTO NAVIGATION:
    // Watchers jump to live automatically when match starts
    // and jump to result automatically when match ends
    if(!m.matchOver){
      goto(2);
    } else {
      goto(3);
    }
  }

  function subscribeToMatch(matchId){
    if(matchUnsub) matchUnsub();
    currentMatchId = matchId;
    if(!matchId){
      setNet(true, "Waiting…");
      goto(0);
      return;
    }
    const mref = ref(db, `matches/${matchId}`);
    matchUnsub = onValue(mref, (snap)=>{
      if(!snap.exists()){
        setNet(false, "Match missing");
        goto(0);
        return;
      }
      setNet(true, "Live");
      renderMatch(snap.val());
    }, (err)=>{
      setNet(false, err?.message || "Listen error");
    });
  }

  // Subscribe to currentMatch pointer (this is the key feature)
  onValue(currentMatchRef, (snap)=>{
    const matchId = snap.val();
    subscribeToMatch(matchId);
  });

  // Auth
  if(role === "scorer"){
    setNet(true, "Signing in…");
    signInAnonymously(auth).catch((e)=>{
      setNet(false, e.message || "Auth failed");
      alert(e.message || "Auth failed");
    });
  } else {
    setNet(true, "Watching…");
  }

  onAuthStateChanged(auth, (user)=>{
    uid = user?.uid || null;
    if(role === "scorer" && uid){
      setNet(true, "Scorer ready");
      // Load saved settings if any
      const saved = JSON.parse(localStorage.getItem("ttfl_settings") || "{}");
      if(saved.nameA) $("nameA").value = saved.nameA;
      if(saved.nameB) $("nameB").value = saved.nameB;
      if(saved.starts) $("starts").value = saved.starts;
      if(saved.bestOf) $("bestOf").value = String(saved.bestOf);
      if(saved.ptWin) $("ptWin").value = String(saved.ptWin);
    }
  });

  // Buttons
  $("btnSettings").onclick = () => goto(1);
  $("btnBackSettings").onclick = () => goto(0);

  $("btnGoLive").onclick = () => {
    if(currentMatchId) goto(2);
    else goto(0);
  };

  $("btnSaveSettings").onclick = () => {
    if(role !== "scorer") return;
    const s = {
      nameA: ($("nameA").value || "Player A").trim(),
      nameB: ($("nameB").value || "Player B").trim(),
      starts: $("starts").value || "A",
      bestOf: Number($("bestOf").value || 5),
      ptWin: Number($("ptWin").value || 11),
    };
    localStorage.setItem("ttfl_settings", JSON.stringify(s));
    setNet(true, "Saved");
    goto(0);
  };

  // Create a new match (no URL changes; updates rooms/{roomId}/currentMatchId)
  async function startNewMatch(){
    if(role !== "scorer") return;
    if(!uid) throw new Error("Scorer not ready yet.");

    const saved = JSON.parse(localStorage.getItem("ttfl_settings") || "{}");
    const teamAName = (saved.nameA || $("nameA").value || "Player A").trim();
    const teamBName = (saved.nameB || $("nameB").value || "Player B").trim();
    const serverStart = saved.starts || $("starts").value || "A";
    const bestOf = Number(saved.bestOf || $("bestOf").value || 5);
    const pointsToWin = Number(saved.ptWin || $("ptWin").value || 11);

    // increment per-room counter safely
    const counterRef = ref(db, `rooms/${roomId}/counter`);
    const tx = await runTransaction(counterRef, (cur)=> (cur || 0) + 1);
    const n = tx.snapshot.val();
    const matchId = `${roomId}-${n}`;

    const init = {
      ownerUid: uid,
      createdAt: iso(),
      updatedAt: iso(),
      match: {
        teamAName, teamBName,
        bestOf, pointsToWin,
        serverStart,
        pointsA: 0, pointsB: 0,
        gamesA: 0, gamesB: 0,
        matchesA: 0, matchesB: 0,
        matchOver: false,
        winner: "",
        startedAt: iso(),
        endedAt: ""
      },
      sets: [],
      history: []
    };

    await set(ref(db, `matches/${matchId}`), init);
    await set(currentMatchRef, matchId); // <-- watchers follow automatically
    return matchId;
  }

  // Home: scorer taps Start (we reuse btnGoLive for both roles; scorer can start if none)
  $("btnGoLive").textContent = (role === "scorer") ? "Start / Go Live" : "Go to Live Score";
  $("btnGoLive").onclick = async () => {
    try{
      if(role === "scorer"){
        // If there is no current match OR current match is over, start a new one
        if(!matchData || !matchData.match || matchData.match.matchOver){
          setNet(true, "Starting match…");
          await startNewMatch();
          goto(2);
        } else {
          goto(2);
        }
      } else {
        if(currentMatchId) goto(2);
        else goto(0);
      }
    }catch(e){
      setNet(false, e.message || "Start failed");
      alert(e.message || "Start failed");
    }
  };

  // Helper: scorer-only write with owner check + undo history
  async function change(mutator){
    if(role !== "scorer") return;
    if(!currentMatchId) throw new Error("No active match.");
    const mref = ref(db, `matches/${currentMatchId}`);
    const snap = await get(mref);
    if(!snap.exists()) throw new Error("Match missing.");

    const s = snap.val();
    if(s.ownerUid !== uid) throw new Error("Another scorer owns this match.");

    s.history = Array.isArray(s.history) ? s.history : [];
    s.history.push({ match: { ...s.match }, sets: [...(s.sets||[])], at: iso() });
    while(s.history.length > 40) s.history.shift();

    mutator(s);

    s.updatedAt = iso();
    await set(mref, s);
  }

  $("btnPlusA").onclick = () => change((s)=>{
    const m = s.match;
    if(m.matchOver) return;
    m.pointsA++;
    const w = gameWinner(m.pointsA, m.pointsB, m.pointsToWin);
    if(w){
      // store the finished game/set score
      s.sets = Array.isArray(s.sets) ? s.sets : [];
      s.sets.push({ a: m.pointsA, b: m.pointsB, endedAt: iso() });

      if(w==="A") m.gamesA++; else m.gamesB++;
      m.pointsA=0; m.pointsB=0;

      // alternate serve start each game
      m.serverStart = (m.serverStart==="A") ? "B" : "A";

      // end match when someone wins enough games
      const needed = need(m.bestOf);
      if(m.gamesA >= needed){
        m.matchesA = 1; m.matchesB = 0;
        m.matchOver = true; m.winner = m.teamAName; m.endedAt = iso();
      }
      if(m.gamesB >= needed){
        m.matchesA = 0; m.matchesB = 1;
        m.matchOver = true; m.winner = m.teamBName; m.endedAt = iso();
      }
    }
  });

  $("btnPlusB").onclick = () => change((s)=>{
    const m = s.match;
    if(m.matchOver) return;
    m.pointsB++;
    const w = gameWinner(m.pointsA, m.pointsB, m.pointsToWin);
    if(w){
      s.sets = Array.isArray(s.sets) ? s.sets : [];
      s.sets.push({ a: m.pointsA, b: m.pointsB, endedAt: iso() });

      if(w==="A") m.gamesA++; else m.gamesB++;
      m.pointsA=0; m.pointsB=0;
      m.serverStart = (m.serverStart==="A") ? "B" : "A";

      const needed = need(m.bestOf);
      if(m.gamesA >= needed){
        m.matchesA = 1; m.matchesB = 0;
        m.matchOver = true; m.winner = m.teamAName; m.endedAt = iso();
      }
      if(m.gamesB >= needed){
        m.matchesA = 0; m.matchesB = 1;
        m.matchOver = true; m.winner = m.teamBName; m.endedAt = iso();
      }
    }
  });

  $("btnUndo").onclick = async () => {
    try{
      if(role !== "scorer") return;
      if(!currentMatchId) return;
      const mref = ref(db, `matches/${currentMatchId}`);
      const snap = await get(mref);
      if(!snap.exists()) return;
      const s = snap.val();
      if(s.ownerUid !== uid) throw new Error("Another scorer owns this match.");
      const h = Array.isArray(s.history) ? s.history : [];
      const prev = h.pop();
      if(!prev) return;
      s.match = prev.match;
      s.sets = prev.sets;
      s.history = h;
      s.updatedAt = iso();
      await set(mref, s);
    }catch(e){
      setNet(false, e.message || "Undo failed");
      alert(e.message || "Undo failed");
    }
  };

  $("btnSwap").onclick = () => change((s)=>{
    s.match.serverStart = (s.match.serverStart==="A") ? "B" : "A";
  });

  $("btnEnd").onclick = () => change((s)=>{
    const m = s.match;
    if(m.matchOver) return;
    m.matchOver = true;
    m.endedAt = iso();
    // pick winner by games
    if(m.gamesA === m.gamesB) m.winner = "Match ended";
    else m.winner = (m.gamesA > m.gamesB) ? m.teamAName : m.teamBName;
    m.matchesA = (m.gamesA > m.gamesB) ? 1 : 0;
    m.matchesB = (m.gamesB > m.gamesA) ? 1 : 0;
  });

  // Result controls
  $("btnBackHome").onclick = () => goto(0);

  $("btnNewMatch").onclick = async () => {
    try{
      setNet(true, "Starting match…");
      await startNewMatch(); // watchers auto-follow
      goto(2);
    }catch(e){
      setNet(false, e.message || "Start failed");
      alert(e.message || "Start failed");
    }
  };

  // Save Result Image: generates a PNG (user tap required). iPhone can Save Image via Share.
  $("btnSaveImage").onclick = async () => {
    try{
      if(!matchData || !matchData.match) return;

      const m = matchData.match;
      const sets = matchData.sets || [];
      const w = 1080, h = 1080; // square social-friendly
      const canvas = document.createElement("canvas");
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext("2d");

      // background
      const grad = ctx.createLinearGradient(0,0,w,h);
      grad.addColorStop(0, "#0b0d12");
      grad.addColorStop(1, "#121826");
      ctx.fillStyle = grad;
      ctx.fillRect(0,0,w,h);

      // header
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.font = "700 44px system-ui, -apple-system, Segoe UI, Roboto";
      ctx.fillText("Table Tennis For Life", 70, 110);
      ctx.font = "800 52px system-ui, -apple-system, Segoe UI, Roboto";
      ctx.fillText("Live Score Card", 70, 170);

      // names
      ctx.font = "700 42px system-ui, -apple-system, Segoe UI, Roboto";
      ctx.fillStyle = "rgba(245,247,255,0.92)";
      ctx.fillText(m.teamAName || "Player A", 70, 270);
      ctx.fillText(m.teamBName || "Player B", 70, 330);

      // match score
      const a = m.matchesA ?? 0;
      const b = m.matchesB ?? 0;

      // pills
      const pill = (x,y,text,bg,fg)=>{
        ctx.fillStyle = bg;
        roundRect(ctx,x,y,260,120,26); ctx.fill();
        ctx.fillStyle = fg;
        ctx.font = "900 72px system-ui, -apple-system, Segoe UI, Roboto";
        ctx.textAlign = "center";
        ctx.fillText(text, x+130, y+84);
        ctx.textAlign = "left";
      };
      pill(70, 400, String(a), "#2f6dff", "#ffffff");
      ctx.fillStyle = "rgba(255,255,255,0.7)";
      ctx.font = "900 72px system-ui, -apple-system, Segoe UI, Roboto";
      ctx.fillText(":", 350, 485);
      pill(420, 400, String(b), "#ff9b2f", "#111111");

      // winner + time
      ctx.fillStyle = "rgba(245,247,255,0.78)";
      ctx.font = "700 34px system-ui, -apple-system, Segoe UI, Roboto";
      const ended = m.endedAt ? new Date(m.endedAt) : new Date();
      ctx.fillText(`Winner: ${m.winner || "-"}`, 70, 575);
      ctx.fillText(`Ended: ${ended.toLocaleString()}`, 70, 625);

      // sets list
      ctx.fillStyle = "rgba(245,247,255,0.92)";
      ctx.font = "900 36px system-ui, -apple-system, Segoe UI, Roboto";
      ctx.fillText("GAMES", 70, 710);

      ctx.font = "800 34px system-ui, -apple-system, Segoe UI, Roboto";
      ctx.fillStyle = "rgba(245,247,255,0.88)";
      let y = 770;
      if(sets.length === 0){
        ctx.fillStyle = "rgba(245,247,255,0.6)";
        ctx.fillText("No games recorded.", 70, y);
      } else {
        sets.slice(0, 10).forEach((s, i)=>{
          ctx.fillText(`${i+1}) ${s.a}-${s.b}`, 70, y);
          y += 46;
        });
      }

      // footer
      ctx.fillStyle = "rgba(245,247,255,0.45)";
      ctx.font = "700 26px system-ui, -apple-system, Segoe UI, Roboto";
      ctx.fillText("Generated by TTFL Live Score", 70, 1020);

      // share / download
      canvas.toBlob(async (blob)=>{
        if(!blob) return;
        const file = new File([blob], "ttfl-result.png", { type: "image/png" });

        // iOS share sheet if available
        if(navigator.canShare && navigator.canShare({ files: [file] })){
          await navigator.share({ files: [file], title: "TTFL Result" });
          return;
        }

        // fallback download
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "ttfl-result.png";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }, "image/png");
    }catch(e){
      alert(e.message || "Save image failed");
    }
  };

  function roundRect(ctx,x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }

  // Init
  goto(0);
  setNet(true, "Starting…");
</script>
</body>
</html>
